<div class="login--container">
<main class="login">
    <p><%= flash.notice %></p>
    <%= form_for @user, html: { class: "body--register" } do |f| %>
        <% if @user.errors.any? %>
            <div id="error_explanation">
                <h2>
                    <%= pluralize(@user.errors.count, "error") %>
                    prohibited this user from being saved:
                </h2>
                <ul>
                    <% @user.errors.full_messages.each do |message| %>
                        <li>
                            <%= message %>
                        </li>
                    <% end %>
                </ul>
            </div>
        <% end %>
        <div class="register--field">
            <%= f.label :first_name %><br>
            <%= f.text_field :first_name %>
        </div>
        <div class="register--field">
            <%= f.label :last_name %><br>
            <%= f.text_field :last_name %>
        </div>
        <div class="register--field">
            <%= f.label "Username" %><br>
            <%= f.text_field :username %>
        </div>
        <div class="register--field">
            <%= f.label :email %><br>
            <%= f.text_field :email %>
        </div>
        <div class="register--field">
            <%= f.label :city %><br>
            <%= f.select :city, [["Lincoln", "Lincoln"], ["Omaha", "Omaha"], ["Sioux Falls", "Sioux Falls"]] %>
        </div>
        <div class="register--field">
            <%= f.label :password %><br />
            <%= f.password_field :password %>
        </div>
        
        <div id="flash-messages"></div>
        <%= javascript_include_tag "https://js.stripe.com/v2/" %>
        <script>
            Stripe.setPublishableKey("<%= ENV["PUBLISHABLE_KEY"] %>");
        </script>
            
        <h3>Pay what you want</h3>
        <%= label_tag "Amount" %>
        <div class="control-group">
            <div class="controls">
                <%= text_field_tag :amount %>
            </div>
        </div>
        <%= label_tag "Card Number", nil %>
        <div class="control-group">
            <div class="controls">
                <%= text_field_tag :card_number, nil, class: "input-block-level", id: "card-number", data: {stripe: "number"} %>
            </div>
        </div>
        <%= label_tag "Card Verification", nil %>
        <div class="control-group">
            <div class="controls">
              <%= text_field_tag :card_verification, nil, class: "input-block-level", data: {stripe: "cvv"} %>
            </div>
        </div>
        <%= label_tag "Card Expires", nil %>
        <%= select_tag :exp_month, options_for_select(Date::MONTHNAMES.compact.each_with_index.map { |name,i| ["#{i+1} - #{name}", i+1] }), include_blank: false, data: {stripe: "exp-month"}, class: "span2" %>
        <%= select_tag :exp_year, options_for_select((Date.today.year..(Date.today.year+10)).to_a), include_blank: false, data: {stripe: "exp-year"}, class: "span1" %>
        <div class="actions">
            <%= f.submit "Sign up" %>
        </div>
    <% end %>
</main>
</div>
<script>
if($("#card-number").val() != "") {
    console.log('here');
    var show_error, stripeResponseHandler;
    $("#new_user").submit(function (event) {
        var $form;
        $form = $(this);
        $form.find("input[type=submit]").prop("disabled", true);
        Stripe.card.createToken($form, stripeResponseHandler);
        return false;
    });

    stripeResponseHandler = function (status, response) {
        var $form, token;
        $form = $("#new_user");
        if (response.error) {
            show_error(response.error.message);
            $form.find("input[type=submit]").prop("disabled", false);
    } else {
        token = response.id;
        $form.append($("<input type=\"hidden\" name=\"user[card_token]\" />").val(token));
        $("[data-stripe=number]").remove();
        $("[data-stripe=cvv]").remove();
        $("[data-stripe=exp-year]").remove();
        $("[data-stripe=exp-month]").remove();
        $form.get(0).submit();
    }
        return false;
    };

    show_error = function (message) {
        $("#flash-messages").html('<div class="alert alert-warning"><a class="close" data-dismiss="alert">Ã—</a><div id="flash_alert">' + message + '</div></div>');
        $('.alert').delay(5000).fadeOut(3000);
        return false;
    };
}
</script>